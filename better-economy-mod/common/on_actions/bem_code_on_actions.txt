on_game_started = {
	on_actions = {
		on_bem_game_started
	}
}

on_bem_game_started = {
	effect = {
		every_country = {
			add_investment_pool = bem_initial_investment_pool
		}

		every_state = {
			every_scope_building = {update_mining_efficiency = yes}
			save_scope_value_as = {
				name = multi
				value = {
					value = bem_state_investment_levels
					subtract = 1
				}
			}
			every_scope_building = {
				remove_modifier = bem_investment_level
				add_modifier = {
					name = bem_investment_level
					multiplier = scope:multi
				}
			}
		}
	}
}

on_monthly_pulse_state = {
	on_actions = {
		on_bem_monthly_pulse_state
	}
}
on_bem_monthly_pulse_state = {
	effect = {
		if = {
			limit = {
				has_modifier = bem_urbanization_boost
			}
			remove_modifier = bem_urbanization_boost
		}
		if = {
			limit = {
				has_modifier = state_rural_nerf
			}
			remove_modifier = state_rural_nerf
		}
		if = {
			limit = {
				bem_urbanization_rate > 0.25
			}
			add_modifier = {
				name = bem_urbanization_boost
				multiplier = bem_urbanization_rate
			}
		}
		else = {
			add_modifier = {
				name = state_rural_nerf
				multiplier = {
					value = 1
					subtract = bem_urbanization_rate
				}
			}
		}

		random_scope_building = {
			limit = {
				is_building_type = building_urban_center
			}
			save_scope_value_as = {
				name = govadlv
				value = {
					value = level
					divide = 3
					ceiling = yes
				}
			}
		}

		create_building = {
			building = building_government_administration
			level = scope:govadlv
		}
		if = {
			limit = {NOT = {has_variable_list = bem_state_building_queue}}
			if = {
				limit = {infrastructure_delta > 2}
				ordered_scope_building = {
					limit = {
						is_buildable = yes
						type = {
							NOT = {
								OR = {
									this = bt:building_naval_base
									this = bt:building_barracks
								}
							}
						}
					}
					order_by = bem_profit_per_level
					type = {save_scope_as = target_building}
					prev = {bem_add_building_to_queue = yes}
				}
			}
			else_if = {
				limit = {
					owner = {has_technology_researched = railways}
					# b:building_railway = {occupancy >= 0.9}
					}
				bt:building_railway = {save_scope_as = target_building}
				prev = {bem_add_building_to_queue = yes}
			}
			else_if = {
				limit = {
					is_coastal = yes
					# b:building_port = {occupancy >= 0.9}
					}
				bt:building_port = {save_scope_as = target_building}
				prev = {bem_add_building_to_queue = yes}
			}
		}
		bem_private_investment_oa = yes
		bem_do_state_building = yes
	}
}

on_acquired_technology = {
	on_actions = {
		bem_on_acquired_technology
	}
}

bem_on_acquired_technology = {
	effect = {
		if = {
			limit = {
					has_technology_researched = joint_stock_companies
					NOT = { has_technology_researched = mutual_funds }
				}
				every_scope_state = {
					limit = {
						b:building_financial_district = { 
								has_active_production_method = pm_financial_district_privately_owned 
							}
						}
					activate_production_method = {
                		building_type = building_financial_district
                		production_method = pm_financial_district_joint_stock
            		}
				}
		}
		if = {
			limit = {
					has_technology_researched = mutual_funds
				}
				every_scope_state = {
					limit = {
						b:building_financial_district = {
								OR = {
									has_active_production_method = pm_financial_district_privately_owned 
									has_active_production_method = pm_financial_district_joint_stock
								}
							}
						}
					activate_production_method = {
                		building_type = building_financial_district
                		production_method = pm_financial_district_publicly_traded
            		}
				}
		}
	}
}