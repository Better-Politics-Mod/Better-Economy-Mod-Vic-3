on_game_started = {
	on_actions = {
		on_bem_game_started
	}
}

on_bem_game_started = {
	effect = {
		every_country = {
			add_investment_pool = bem_initial_investment_pool
		}

		every_country = {
			limit = {any_subject_or_below = {exists = yes}}
			every_direct_subject = {
				prev = {
					create_diplomatic_pact = {
						country = prev
						type = grant_own_market
					}
				}
			}
		}

		every_country = {
			limit = {
				NOT = {this = this.overlord}
				is_subject = true
				}
			create_treaty = {  
				name = bem_subject_market_treaty
				first_country = this
				second_country = this.overlord
				is_draft = no
				articles_to_create = {
					{  
						article = overlord_trade_privilege
						source_country = this
						target_country = this.overlord
					}
					{  
						article = overlord_trade_privilege
						source_country = this.overlord
						target_country = this
					}
					{  
						article = overlord_transit_rights
						source_country = this
						target_country = this.overlord
					}
					{  
						article = overlord_transit_rights
						source_country = this.overlord
						target_country = this
					}
				}
			}
		}
		
		every_state = {
			every_scope_building = {update_mining_efficiency = yes}
			#save_scope_value_as = {
			#	name = multi
			#	value = {
			#		value = bem_state_investment_levels
			#		subtract = 1
			#	}
			#}
			#every_scope_building = {
			#	remove_modifier = bem_investment_level
			#	add_modifier = {
			#		name = bem_investment_level
			#		multiplier = scope:multi
			#	}
			#}
			set_local_variable = {
				name = mult
				value = used_trade_capacity
			}
			add_modifier = {
				name = bem_trade
				multiplier = local_var:mult
			}
			set_local_variable = {
				name = capex_mult
				value = bem_construction_buy_package
			}
			add_modifier = {
				name = bem_state_capex
				multiplier = local_var:capex_mult
			}
		}

		every_state = {
			limit = {is_capital = yes}
			create_building = {
				building = building_consec_dummy
				level = 1
			}
		}

		every_state = {
			limit = {
				b:building_trade_center ?= {
					level > 1
				} 
			}
			remove_building = building_trade_center
			create_building = {
				building = building_trade_center
				level = 1
			}
		}

		every_country = {
			save_scope_as = company_owner
			scope:company_owner = {
				owning_company ?= {
					remove_owned_country = scope:company_owner
					owner ?= {
						remove_company = prev.type
					}
				}
			}
		}
	}
}

on_monthly_pulse_state = {
	on_actions = {
		on_bem_monthly_pulse_state
	}
}
on_bem_monthly_pulse_state = {
	effect = {
		if = {
			limit = {
				b:building_trade_center ?= {
					level > 1
				} 
			}
			remove_building = building_trade_center
			create_building = {
				building = building_trade_center
				level = 1
			}
		}
		if = {
			limit = {
				has_modifier = bem_urbanization_boost
			}
			remove_modifier = bem_urbanization_boost
		}
		if = {
			limit = {
				has_modifier = state_rural_nerf
			}
			remove_modifier = state_rural_nerf
		}
		if = {
			limit = {
				state_urbanization_rate > 0.50
			}
			add_modifier = {
				name = bem_urbanization_boost
				multiplier = {
					value = state_urbanization_rate
					subtract = 0.5
				}
			}
		}
		else = {
			add_modifier = {
				name = state_rural_nerf
				multiplier = {
					value = 0.5
					subtract = state_urbanization_rate
					multiply = 2
				}
			}
		}

		create_building = {
			building = building_government_administration
			level = scope:govadlv
		}
		if = {
			limit = {NOT = {has_variable_list = bem_state_building_queue}}
			if = {
				limit = {NOT = {exists = b:building_construction_sector}}
				bt:building_construction_sector = {save_scope_as = target_building}
				prev = {bem_add_building_to_queue = yes}
			}
			else_if = {
				limit = {infrastructure_delta > 2}
				if = {
					limit = {
						exists = b:building_government_administration
						owner = {
							OR = {
								approaching_bureaucracy_shortage = yes
								relative_bureaucracy <= 0
							}
						}
					}
					bt:building_government_administration = {save_scope_as = target_building}
					prev = {bem_add_building_to_queue = yes}
				}
				else = {
					ordered_scope_building = {
					limit = {
						is_buildable = yes
						type = {
							NOT = {
								OR = {
									this = bt:building_naval_base
									this = bt:building_barrack
									this = bt:building_trade_center
								}
							}
						}
					}
					order_by = bem_profit_per_level
					position = 0
					type = {save_scope_as = target_building}
					prev = {bem_add_building_to_queue = yes}
					}
				}
			}
			else_if = {
				limit = {
					owner = {has_technology_researched = railways}
					# b:building_railway = {occupancy >= 0.9}
					}
				bt:building_railway = {save_scope_as = target_building}
				prev = {bem_add_building_to_queue = yes}
			}
			else_if = {
				limit = {
					is_coastal = yes
					# b:building_port = {occupancy >= 0.9}
					}
				bt:building_port = {save_scope_as = target_building}
				prev = {bem_add_building_to_queue = yes}
			}
		}
		bem_do_state_building = yes
	}
}

on_acquired_technology = {
	on_actions = {
		bem_on_acquired_technology
	}
}

bem_on_acquired_technology = {
	effect = {
		if = {
			limit = {
					has_technology_researched = joint_stock_companies
					NOT = { has_technology_researched = mutual_funds }
				}
				every_scope_state = {
					limit = {
						b:building_financial_district = { 
								has_active_production_method = pm_financial_district_privately_owned 
							}
						}
					activate_production_method = {
                		building_type = building_financial_district
                		production_method = pm_financial_district_joint_stock
            		}
				}
		}
		if = {
			limit = {
					has_technology_researched = mutual_funds
				}
				every_scope_state = {
					limit = {
						b:building_financial_district = {
								OR = {
									has_active_production_method = pm_financial_district_privately_owned 
									has_active_production_method = pm_financial_district_joint_stock
								}
							}
						}
					activate_production_method = {
                		building_type = building_financial_district
                		production_method = pm_financial_district_publicly_traded
            		}
				}
		}
	}
}

on_become_subject = {
	on_actions = {
		bem_on_become_subject
	}
}

bem_on_become_subject = {
	effect = {
		overlord = {
			create_diplomatic_pact = {
				country = prev
				type = grant_own_market
			}
		}

		create_treaty = {  
			name = bem_subject_market_treaty
			first_country = this
			second_country = this.overlord
			is_draft = no
			articles_to_create = {
				{  
					article = overlord_trade_privilege
					source_country = this
					target_country = this.overlord
				}
				{  
					article = overlord_trade_privilege
					source_country = this.overlord
					target_country = this
				}
				{  
					article = overlord_transit_rights
					source_country = this
					target_country = this.overlord
				}
				{  
					article = overlord_transit_rights
					source_country = this.overlord
					target_country = this
				}
			}
		}
	}
}